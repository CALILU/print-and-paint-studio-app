<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print and Paint Studio - Gesti√≥n de Videos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .sidebar {
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
        }
        .sidebar a {
            color: #ced4da;
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            transition: all 0.3s;
        }
        .sidebar a:hover {
            background-color: #495057;
            color: white;
        }
        .sidebar a.active {
            background-color: #dc3545;
            color: white;
        }
        .sidebar-heading {
            padding: 0 15px 20px 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid #495057;
            margin-bottom: 20px;
        }
        .content {
            padding: 20px;
            margin-left: 250px;
        }
        .content-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .card {
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #dc3545;
            color: white;
        }
        .admin-badge {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        .btn-primary {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-primary:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .video-container {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .video-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .video-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .youtube-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .youtube-container iframe, .youtube-container div {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .technique-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #dc3545;
            transition: all 0.3s;
        }
        .technique-item:hover {
            background-color: #f1f1f1;
            border-left-width: 5px;
        }
        .badge-beginner {
            background-color: #28a745;
        }
        .badge-intermediate {
            background-color: #fd7e14;
        }
        .badge-expert {
            background-color: #dc3545;
        }
        .techniques-container {
            max-height: 250px;
            overflow-y: auto;
        }
        .technique-item a {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        .technique-item a:hover {
            color: #dc3545;
            text-decoration: underline;
        }
        .technique-highlight {
            background-color: rgba(220, 53, 69, 0.1);
            border-left-color: #dc3545;
            font-weight: bold;
        }
        .time-selector {
            display: inline-block;
            background-color: #f8d7da;
            color: #721c24;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-selector:hover {
            background-color: #721c24;
            color: white;
            transform: scale(1.05);
        }
        .time-text {
            font-weight: bold;
        }
        .technique-content {
            margin-bottom: 8px;
        }
        .tab-content {
            padding: 20px 0;
        }
        .nav-pills .nav-link.active {
            background-color: #dc3545;
        }
        .nav-pills .nav-link {
            color: #495057;
        }
        .form-section {
            border-left: 3px solid #dc3545;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        .drag-drop-area {
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            background-color: #f8f9fa;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .drag-drop-area:hover {
            border-color: #dc3545;
            background-color: #f8f9fa;
        }
        .drag-drop-area.dragover {
            border-color: #28a745;
            background-color: #e8f5e9;
        }
        .checkbox-filter {
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            margin-bottom: 15px;
        }
        .category-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .category-pill {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            background-color: #f1f1f1;
            cursor: pointer;
            transition: all 0.2s;
        }
        .category-pill:hover, .category-pill.active {
            background-color: #dc3545;
            color: white;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .empty-message {
            background-color: #f8f9fa;
            padding: 50px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
        }
        .filter-chip {
            display: inline-block;
            background-color: #e9ecef;
            color: #495057;
            border-radius: 16px;
            padding: 5px 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        .filter-chip .close {
            margin-left: 8px;
            cursor: pointer;
        }
        .tooltip-inner {
            max-width: 200px;
            padding: 8px 10px;
            color: #fff;
            text-align: center;
            background-color: #dc3545;
            border-radius: 4px;
        }
        .form-floating {
            margin-bottom: 15px;
        }
        .thumbnail-preview {
            width: 100%;
            height: 180px;
            background-color: #e9ecef;
            background-position: center;
            background-size: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .technique-tag {
            display: inline-block;
            background-color: #f8f9fa;
            color: #495057;
            padding: 3px 10px;
            border-radius: 3px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.85rem;
            border: 1px solid #dee2e6;
        }
        .video-actions {
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 4px;
            padding: 5px;
        }
        .video-container:hover .video-actions {
            opacity: 1;
        }
        .action-icon {
            color: white;
            margin: 0 5px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .batch-actions {
            display: none;
            margin-bottom: 20px;
        }
        
        /* NUEVO: Estilos para modales superpuestos */
        .modal-stacked {
            z-index: 1060;
        }
        
        .modal-backdrop.show.secondary-modal {
            z-index: 1055;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            .content {
                margin-left: 0;
            }
            .video-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para el modal de pinturas */
        .paint-item {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .paint-item:hover {
            border-color: #6c757d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .paint-item.selected {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .paint-item.associated {
            border-color: #28a745;
            background-color: #f8fff8;
        }

        .paint-color-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            border: 2px solid #dee2e6;
        }

        .associated-paint-chip {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 0.8rem;
        }

        .associated-paint-chip .remove-paint {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Estilos para lazy loading de videos */
        .lazy-load-video {
            transition: opacity 0.3s ease-in-out;
            opacity: 0.8;
        }
        .lazy-load-video.loaded {
            opacity: 1;
        }
        .youtube-container img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .youtube-container:hover img {
            filter: brightness(0.8);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="sidebar-heading">
                    Print and Paint Studio <span class="admin-badge">ADMIN</span>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                            <i class="bi bi-speedometer2 me-2"></i> Panel
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('admin_videos') }}">
                            <i class="bi bi-collection-play me-2"></i> Gesti√≥n de Videos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_categories') }}">
                            <i class="bi bi-tags me-2"></i> Gesti√≥n de Categor√≠as
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_paints') }}">
                            <i class="bi bi-palette me-2"></i> Gesti√≥n de Pinturas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_users') }}">
                            <i class="bi bi-people me-2"></i> Gesti√≥n de Usuarios
                        </a>
                    </li>
                    <li class="nav-item mt-5">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="bi bi-box-arrow-left me-2"></i> Cerrar Sesi√≥n
                        </a> 
                    </li>
                </ul>
            </div>
            
            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content">
                <div class="content-header">
                    <h1>Gesti√≥n de Videos</h1>
                    <p>Administra los videos de t√©cnicas de pintura para modelos 3D en resina</p>
                </div>
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Navigation Tabs -->
                <ul class="nav nav-pills mb-4" id="adminVideosTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="video-list-tab" data-bs-toggle="pill" data-bs-target="#video-list" type="button" role="tab" aria-controls="video-list" aria-selected="true">
                            <i class="bi bi-grid me-1"></i> Videos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="add-video-tab" data-bs-toggle="pill" data-bs-target="#add-video" type="button" role="tab" aria-controls="add-video" aria-selected="false">
                            <i class="bi bi-plus-circle me-1"></i> A√±adir Video
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="techniques-tab" data-bs-toggle="pill" data-bs-target="#techniques" type="button" role="tab" aria-controls="techniques" aria-selected="false" style="display: none;">
                            <i class="bi bi-list-check me-1"></i> T√©cnicas
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="adminVideosTabsContent">
                    <!-- Videos List Tab -->
                    <div class="tab-pane fade show active" id="video-list" role="tabpanel" aria-labelledby="video-list-tab">
                        <!-- Search and filters -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-search me-2"></i> Buscar y Filtrar Videos
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="searchInput" placeholder="Buscar por t√≠tulo, descripci√≥n o canal...">
                                            <button class="btn btn-primary" type="button" onclick="searchVideos()">
                                                <i class="bi bi-search"></i> Buscar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters" aria-expanded="false" aria-controls="advancedFilters">
                                            <i class="bi bi-funnel"></i> Filtros avanzados
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="collapse" id="advancedFilters">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Filtrar por categor√≠a:</label>
                                            <select class="form-select" id="categoryFilter" onchange="updateCategoryFilter()">
                                                <option value="all">Todas las categor√≠as</option>
                                                <option value="Sin categor√≠a">Sin categor√≠a</option>
                                                <option value="Pintura Base">Pintura Base</option>
                                                <option value="Sombreado">Sombreado</option>
                                                <option value="Iluminaci√≥n">Iluminaci√≥n</option>
                                                <option value="Detalles">Detalles</option>
                                                <option value="Efectos Especiales">Efectos Especiales</option>
                                                <option value="Barnizado">Barnizado</option>
                                                <option value="Peanas">Peanas</option>
                                                <option value="Otros">Otros</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Filtrar por dificultad:</label>
                                            <div class="category-selector">
                                                <div class="category-pill active" data-difficulty="all">Todos</div>
                                                <div class="category-pill" data-difficulty="beginner">Principiante</div>
                                                <div class="category-pill" data-difficulty="intermediate">Intermedio</div>
                                                <div class="category-pill" data-difficulty="expert">Experto</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="checkbox-filter">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="filterHasTechniques">
                                                    <label class="form-check-label" for="filterHasTechniques">Solo videos con t√©cnicas</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="filterNoTechniques">
                                                    <label class="form-check-label" for="filterNoTechniques">Solo videos sin t√©cnicas</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="activeFilters" class="mt-3"></div>
                                    
                                    <div class="d-flex justify-content-end mt-3">
                                        <button class="btn btn-secondary me-2" onclick="clearFilters()">Limpiar filtros</button>
                                        <button class="btn btn-primary" onclick="applyFilters()">Aplicar filtros</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Batch actions -->
                        <div class="batch-actions" id="batchActions">
                            <div class="alert alert-info d-flex justify-content-between align-items-center">
                                <div>
                                    <span id="selectedCount">0</span> videos seleccionados
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger me-2" onclick="deleteSelectedVideos()">
                                        <i class="bi bi-trash"></i> Eliminar seleccionados
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                        <i class="bi bi-x"></i> Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Videos display -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Videos <span class="badge bg-secondary" id="videoCount">0</span></h3>
                            <div class="btn-group">
                                <button id="gridViewBtn" class="btn btn-outline-secondary active" onclick="setViewMode('grid')">
                                    <i class="bi bi-grid"></i>
                                </button>
                                <button id="listViewBtn" class="btn btn-outline-secondary" onclick="setViewMode('list')">
                                    <i class="bi bi-list"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="videos-container" class="video-grid">
                            <div class="empty-message">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-3">Cargando videos...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add/Edit Video Tab -->
                    <div class="tab-pane fade" id="add-video" role="tabpanel" aria-labelledby="add-video-tab">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-plus-circle me-2"></i> <span id="form-title">A√±adir Nuevo Video</span>
                            </div>
                            <div class="card-body">
                                <form id="videoForm">
                                    <input type="hidden" id="video_id_edit" value="">
                                    
                                    <!-- Main video info -->
                                    <div class="form-section">
                                        <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i> Informaci√≥n General</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="title" placeholder="T√≠tulo del video" required>
                                                    <label for="title">T√≠tulo*</label>
                                                </div>
                                                
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="youtube_id" placeholder="ID de YouTube" required>
                                                    <label for="youtube_id">ID de YouTube*</label>
                                                    <div class="form-text">Ej: dQw4w9WgXcQ (de https://www.youtube.com/watch?v=dQw4w9WgXcQ)</div>
                                                </div>
                                                
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="channel" placeholder="Canal">
                                                    <label for="channel">Canal</label>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <textarea class="form-control" id="description" placeholder="Descripci√≥n" style="height: 100px"></textarea>
                                                    <label for="description">Descripci√≥n</label>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-floating mb-3">
                                                            <select class="form-select" id="category_id">
                                                                <option value="">Sin categor√≠a</option>
                                                                <!-- Las categor√≠as se cargar√°n din√°micamente -->
                                                            </select>
                                                            <label for="category_id">Categor√≠a</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-floating mb-3">
                                                            <select class="form-select" id="difficulty_level">
                                                                <option value="beginner">Principiante</option>
                                                                <option value="intermediate">Intermedio</option>
                                                                <option value="expert">Experto</option>
                                                            </select>
                                                            <label for="difficulty_level">Nivel de Dificultad</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Technique timing -->
                                    <div class="form-section">
                                        <h5 class="mb-3"><i class="bi bi-clock me-2"></i> Tiempo de T√©cnica Principal</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Tiempo inicial</label>
                                                <div class="input-group mb-3">
                                                    <input type="number" class="form-control" id="technique_start_time_min" min="0" placeholder="Minutos">
                                                    <span class="input-group-text">:</span>
                                                    <input type="number" class="form-control" id="technique_start_time_sec" min="0" max="59" placeholder="Segundos">
                                                    <input type="hidden" id="technique_start_time" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Tiempo final</label>
                                                <div class="input-group mb-3">
                                                    <input type="number" class="form-control" id="technique_end_time_min" min="0" placeholder="Minutos">
                                                    <span class="input-group-text">:</span>
                                                    <input type="number" class="form-control" id="technique_end_time_sec" min="0" max="59" placeholder="Segundos">
                                                    <input type="hidden" id="technique_end_time" value="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview -->
                                    <div class="form-section">
                                        <h5 class="mb-3"><i class="bi bi-eye me-2"></i> Vista Previa</h5>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div id="thumbnailPreview" class="thumbnail-preview">
                                                    <div class="d-flex justify-content-center align-items-center h-100">
                                                        <span class="text-muted">La miniatura se generar√° autom√°ticamente</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div id="videoDataPreview">
                                                    <p class="text-muted">Ingresa la informaci√≥n del video para ver una vista previa.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between mt-4">
                                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancelar</button>
                                        <button type="submit" class="btn btn-primary" id="submit-btn">Guardar Video</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Techniques Tab -->
                    <div class="tab-pane fade" id="techniques" role="tabpanel" aria-labelledby="techniques-tab">
                        <div class="card mb-4">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-list-check me-2"></i> T√©cnicas del Video
                                    </div>
                                    <div id="videoTitleDisplay" class="fw-bold"></div>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Campo oculto para el ID de YouTube actual -->
                                <input type="hidden" id="currentYoutubeId" value="">
                                
                                <!-- Video preview for techniques -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="youtube-container">
                                            <div id="techniquesVideoPreview"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="techniqueTiming" class="mb-3">
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle me-2"></i> Selecciona una t√©cnica para ver la demostraci√≥n en el video.
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" id="captureTimeBtn" onclick="captureCurrentTime()">
                                            <i class="bi bi-clock"></i> Capturar tiempo actual
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Add new technique -->
                                <div class="form-section">
                                    <h5 class="mb-3"><i class="bi bi-plus-circle me-2"></i> A√±adir Nueva T√©cnica</h5>
                                    <form id="techniqueForm">
                                        <input type="hidden" id="technique_id_edit" value="">
                                        <input type="hidden" id="technique_video_id" value="">
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="technique_name" placeholder="Nombre de la t√©cnica" required>
                                                    <label for="technique_name">Nombre de la T√©cnica*</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Tiempo Inicial*</label>
                                                <div class="input-group mb-3">
                                                    <input type="number" class="form-control" id="technique_start_min" min="0" placeholder="Min" required>
                                                    <span class="input-group-text">:</span>
                                                    <input type="number" class="form-control" id="technique_start_sec" min="0" max="59" placeholder="Seg" required>
                                                    <input type="hidden" id="technique_start" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Tiempo Final*</label>
                                                <div class="input-group mb-3">
                                                    <input type="number" class="form-control" id="technique_end_min" min="0" placeholder="Min" required>
                                                    <span class="input-group-text">:</span>
                                                    <input type="number" class="form-control" id="technique_end_sec" min="0" max="59" placeholder="Seg" required>
                                                    <input type="hidden" id="technique_end" value="0">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-secondary me-2" onclick="resetTechniqueForm()">Cancelar</button>
                                            <button type="submit" class="btn btn-primary" id="technique-submit-btn">A√±adir T√©cnica</button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Existing techniques -->
                                <div class="form-section mt-4">
                                    <h5 class="mb-3"><i class="bi bi-list-ul me-2"></i> T√©cnicas Existentes</h5>
                                    <div class="techniques-container" id="techniques-list">
                                        <div class="alert alert-info">No hay t√©cnicas asociadas a este video.</div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-secondary" onclick="goBackToVideos()">
                                        <i class="bi bi-arrow-left"></i> Volver a Videos
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="finishEditingTechniques()">
                                        <i class="bi bi-check-circle"></i> Finalizar Edici√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- MODIFICADO: Preview Modal con bot√≥n de pinturas -->
                <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="previewModalLabel">
                                    <i class="bi bi-eye me-2"></i> Vista Previa - <span id="previewVideoTitle"></span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="youtube-container">
                                    <iframe id="previewIframe" src="" frameborder="0" allowfullscreen></iframe>
                                </div>
                                <div class="mt-3">
                                    <h6><i class="bi bi-list-check me-2"></i> T√©cnicas en este video:</h6>
                                    <div id="previewTechniques"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <!-- NUEVO: Bot√≥n de pinturas en el modal de vista previa -->
                                <button type="button" class="btn btn-warning me-auto" id="previewPaintsBtn" onclick="openPaintsModalFromPreview()">
                                    <i class="bi bi-palette me-2"></i> Gestionar Pinturas
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Confirmation Modal -->
                <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminaci√≥n</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ¬øEst√°s seguro de que deseas eliminar este video? Esta acci√≥n no se puede deshacer.
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para clonar video -->
                <div class="modal fade" id="cloneVideoModal" tabindex="-1" aria-labelledby="cloneVideoModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="cloneVideoModalLabel">Clonar Video para Otro Nivel</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="cloneForm" method="POST">
                                <div class="modal-body">
                                    <p id="cloneVideoDescription">Selecciona el nivel de dificultad para la nueva versi√≥n del video.</p>
                                    
                                    <div class="mb-3">
                                        <label for="cloneDifficultyLevel" class="form-label">Nivel de Dificultad</label>
                                        <select class="form-select" id="cloneDifficultyLevel" name="difficulty_level" required>
                                            <option value="beginner">Principiante</option>
                                            <option value="intermediate">Intermedio</option>
                                            <option value="expert">Experto</option>
                                        </select>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i> La nueva versi√≥n tendr√° los mismos datos pero podr√°s personalizar las t√©cnicas espec√≠ficas para este nivel.
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Clonar Video</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- MODIFICADO: Modal para gestionar pinturas del video con z-index superior -->
                <div class="modal fade modal-stacked" id="paintsModal" tabindex="-1" aria-labelledby="paintsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="paintsModalLabel">
                                    <i class="bi bi-palette me-2"></i> Gestionar Pinturas - <span id="paintsVideoTitle"></span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Filtros de b√∫squeda -->
                                <div class="row mb-4">
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="searchPaintsInput" placeholder="Buscar pinturas por nombre, marca, c√≥digo...">
                                            <button class="btn btn-outline-secondary" type="button" onclick="searchPaintsInModal()">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select" id="filterPaintsBrand" onchange="filterPaintsInModal()">
                                            <option value="">Todas las marcas</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Pinturas asociadas actualmente -->
                                <div class="mb-4">
                                    <h6><i class="bi bi-check-circle me-2"></i> Pinturas asociadas a este video (<span id="associatedPaintsCount">0</span>)</h6>
                                    <div id="associatedPaintsList" class="d-flex flex-wrap gap-2 mb-3">
                                        <!-- Se llenar√°n din√°micamente -->
                                    </div>
                                </div>
                                
                                <!-- Lista de todas las pinturas disponibles -->
                                <div>
                                    <h6><i class="bi bi-palette me-2"></i> Pinturas disponibles</h6>
                                    <div id="availablePaintsList" class="row">
                                        <div class="col-12 text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando pinturas...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-primary" onclick="savePaintAssociations()">
                                    <i class="bi bi-check-circle me-2"></i> Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√≥n para abrir modal de estad√≠sticas -->                 
                <div class="position-fixed" style="bottom: 30px; right: 30px; z-index: 1000;">
                    <button type="button" class="btn btn-primary btn-lg rounded-circle shadow" 
                            data-bs-toggle="modal" data-bs-target="#statisticsModal" 
                            onclick="loadStatistics()">
                        <i class="bi bi-bar-chart-fill"></i>
                    </button>
                </div>

                <!-- Modal de Estad√≠sticas -->
                <div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="statisticsModalLabel">
                                    <i class="bi bi-bar-chart-fill me-2"></i> Estad√≠sticas del Sistema
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Indicador de carga -->
                                <div id="statisticsLoading" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando estad√≠sticas...</span>
                                    </div>
                                    <p class="mt-3">Cargando estad√≠sticas...</p>
                                </div>
                                
                                <!-- Contenido de estad√≠sticas -->
                                <div id="statisticsContent" style="display: none;">
                                    <!-- Pesta√±as de estad√≠sticas -->
                                    <ul class="nav nav-tabs" id="statsTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                                                <i class="bi bi-grid-1x2-fill me-1"></i> Resumen
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-stats" type="button" role="tab" aria-controls="users-stats" aria-selected="false">
                                                <i class="bi bi-people-fill me-1"></i> Usuarios
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="videos-tab" data-bs-toggle="tab" data-bs-target="#videos-stats" type="button" role="tab" aria-controls="videos-stats" aria-selected="false">
                                                <i class="bi bi-collection-play-fill me-1"></i> Videos
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="techniques-tab" data-bs-toggle="tab" data-bs-target="#techniques-stats" type="button" role="tab" aria-controls="techniques-stats" aria-selected="false">
                                                <i class="bi bi-list-check me-1"></i> T√©cnicas
                                            </button>
                                        </li>
                                    </ul>
                                    
                                    <!-- Contenido de las pesta√±as -->
                                    <div class="tab-content mt-3" id="statsTabContent">
                                        <!-- Pesta√±a de Resumen -->
                                        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                                            <div class="row">
                                                <!-- M√©tricas principales -->
                                                <div class="col-md-3 mb-4">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h5 class="card-title"><i class="bi bi-people-fill text-primary"></i></h5>
                                                            <h2 class="display-4 fw-bold" id="totalUsers">-</h2>
                                                            <p class="text-muted">Usuarios registrados</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-4">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h5 class="card-title"><i class="bi bi-collection-play text-success"></i></h5>
                                                            <h2 class="display-4 fw-bold" id="totalVideos">-</h2>
                                                            <p class="text-muted">Videos totales</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-4">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h5 class="card-title"><i class="bi bi-bookmark-check-fill text-warning"></i></h5>
                                                            <h2 class="display-4 fw-bold" id="totalTechniques">-</h2>
                                                            <p class="text-muted">T√©cnicas creadas</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-4">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h5 class="card-title"><i class="bi bi-heart-fill text-danger"></i></h5>
                                                            <h2 class="display-4 fw-bold" id="totalFavorites">-</h2>
                                                            <p class="text-muted">Favoritos totales</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <!-- Videos populares -->
                                                <div class="col-md-6 mb-4">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <i class="bi bi-star-fill me-2"></i> Videos m√°s populares
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="table-responsive">
                                                                <table class="table table-hover">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>T√≠tulo</th>
                                                                            <th class="text-end">Favoritos</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="popularVideosList">
                                                                        <tr>
                                                                            <td colspan="2" class="text-center">No hay datos disponibles</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Usuarios activos -->
                                                <div class="col-md-6 mb-4">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <i class="bi bi-person-check-fill me-2"></i> Usuarios m√°s activos
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="table-responsive">
                                                                <table class="table table-hover">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Usuario</th>
                                                                            <th class="text-end">Favoritos</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="activeUsersList">
                                                                        <tr>
                                                                            <td colspan="2" class="text-center">No hay datos disponibles</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Pesta√±a de Usuarios -->
                                        <div class="tab-pane fade" id="users-stats" role="tabpanel" aria-labelledby="users-tab">
                                            <div class="row">
                                                <div class="col-md-6 mb-4">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <i class="bi bi-person-badge me-2"></i> Distribuci√≥n de usuarios
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between mb-3">
                                                                <div class="text-center">
                                                                    <h5 id="regularUsers">-</h5>
                                                                    <p class="text-muted">Usuarios</p>
                                                                </div>
                                                                <div class="text-center">
                                                                    <h5 id="adminUsers">-</h5>
                                                                    <p class="text-muted">Administradores</p>
                                                                </div>
                                                            </div>
                                                            <div id="usersChart" style="height: 250px;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 mb-4">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <i class="bi bi-bar-chart-line me-2"></i> Usuarios por nivel de experiencia
                                                        </div>
                                                        <div class="card-body">
                                                            <div id="userLevelsChart" style="height: 300px;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Pesta√±a de Videos -->
                                        <div class="tab-pane fade" id="videos-stats" role="tabpanel" aria-labelledby="videos-tab">
                                            <div class="row">
                                                <div class="col-md-6 mb-4">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <i class="bi bi-bar-chart-line me-2"></i> Videos por nivel de dificultad
                                                        </div>
                                                        <div class="card-body">
                                                            <div id="videoDifficultyChart" style="height: 300px;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 mb-4">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <i class="bi bi-pie-chart me-2"></i> Videos por categor√≠a
                                                        </div>
                                                        <div class="card-body">
                                                            <div id="videoCategoriesChart" style="height: 300px;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-12 mb-4">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <i class="bi bi-list-ol me-2"></i> Videos con m√°s t√©cnicas
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="table-responsive">
                                                                <table class="table table-hover">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>T√≠tulo</th>
                                                                            <th class="text-end">N√∫mero de t√©cnicas</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="videosWithMostTechniquesList">
                                                                        <tr>
                                                                            <td colspan="2" class="text-center">No hay datos disponibles</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Pesta√±a de T√©cnicas -->
                                        <div class="tab-pane fade" id="techniques-stats" role="tabpanel" aria-labelledby="techniques-tab">
                                            <div class="row">
                                                <div class="col-md-4 mb-4">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h5 class="card-title">Total de t√©cnicas</h5>
                                                            <h2 class="display-4 fw-bold" id="techniquesCount">-</h2>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-4 mb-4">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h5 class="card-title">Promedio por video</h5>
                                                            <h2 class="display-4 fw-bold" id="avgTechniquesPerVideo">-</h2>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-4 mb-4">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h5 class="card-title">Tiempo total de contenido</h5>
                                                            <h2 class="display-4 fw-bold" id="totalTechniquesDuration">-</h2>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- API de YouTube (agregada) -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // Variables globales
        let allVideos = [];
        let currentSearchTerm = '';
        let currentCategory = 'all';
        let currentDifficulty = 'all';
        let previewModal;
        let confirmDeleteModal;
        let videoToDelete = null;
        let activeVideoTimer = null;
        let viewMode = 'grid';
        let selectedVideos = new Set();
        let tooltips = [];
        let youtubePlayer; // Variable para el reproductor de YouTube
        
        // NUEVAS variables globales para gesti√≥n de pinturas
        let allPaintsModal = [];
        let currentVideoId = null;
        let currentVideoTitle = ''; // NUEVO: para almacenar el t√≠tulo del video actual
        let associatedPaints = new Set();
        let paintsModal;
        let isOpenedFromPreview = false; // NUEVO: flag para saber si se abri√≥ desde preview

        // NUEVA funci√≥n para abrir modal de pinturas desde el modal de preview
        function openPaintsModalFromPreview() {
            if (!currentVideoId || !currentVideoTitle) {
                alert('Error: No se pudo identificar el video actual');
                return;
            }
            
            isOpenedFromPreview = true; // Marcar que se abri√≥ desde preview
            openPaintsModal(currentVideoId, currentVideoTitle);
        }

        // Funci√≥n para cargar estad√≠sticas
        async function loadStatistics() {
            try {
                // Cargar videos para contar
                const videosResponse = await fetch('/api/videos');
                if (!videosResponse.ok) {
                    throw new Error('Error al cargar videos');
                }
                const videos = await videosResponse.json();
                document.querySelector('.videos-count').textContent = videos.length;
                
                // Obtener categor√≠as √∫nicas
                const categories = new Set();
                videos.forEach(video => {
                    if (video.category) {
                        categories.add(video.category);
                    } else {
                        categories.add('Sin categor√≠a');
                    }
                });
                document.querySelector('.categories-count').textContent = categories.size;
                
                // Solicitud para obtener diagn√≥stico que incluye conteos
                const diagnosticResponse = await fetch('/debug/db');
                if (!diagnosticResponse.ok) {
                    throw new Error('Error al cargar diagn√≥stico');
                }
                
                const data = await diagnosticResponse.json();
                
                // Extraer cantidad de usuarios
                if (data.tables && data.tables.users) {
                    const usersMatch = data.tables.users.match(/\((\d+) registros\)/);
                    if (usersMatch && usersMatch[1]) {
                        document.querySelector('.users-count').textContent = usersMatch[1];
                    } else {
                        document.querySelector('.users-count').textContent = '0';
                    }
                }
                
                // Extraer cantidad de favoritos
                if (data.tables && data.tables.favorites) {
                    const favoritesMatch = data.tables.favorites.match(/\((\d+) registros\)/);
                    if (favoritesMatch && favoritesMatch[1]) {
                        document.querySelector('.favorites-count').textContent = favoritesMatch[1];
                    } else {
                        document.querySelector('.favorites-count').textContent = '0';
                    }
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
                document.querySelector('.videos-count').textContent = '-';
                document.querySelector('.users-count').textContent = '-';
                document.querySelector('.favorites-count').textContent = '-';
                document.querySelector('.categories-count').textContent = '-';
            }
        }
        
        // Funci√≥n para actualizar el filtro de categor√≠a
        function updateCategoryFilter() {
            const select = document.getElementById('categoryFilter');
            currentCategory = select.value;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar tooltips
            initTooltips();
            
            // Inicializar modales
            previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
            confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            
            // Cargar categor√≠as
            loadCategories();
            
            // Configurar formulario de videos
            const videoForm = document.getElementById('videoForm');
            videoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveVideo();
            });
            
            // Configurar formulario de t√©cnicas
            const techniqueForm = document.getElementById('techniqueForm');
            techniqueForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveTechnique();
            });
            
            // Configurar bot√≥n de confirmaci√≥n de eliminaci√≥n
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                if (videoToDelete) {
                    deleteVideo(videoToDelete);
                    videoToDelete = null;
                    confirmDeleteModal.hide();
                }
            });
            
            // Inicializar conversi√≥n y validaci√≥n de tiempo
            initTimeInputs();
            
            // Configurar filtros de dificultad (mantener existente)
            document.querySelectorAll('.category-pill').forEach(pill => {
                pill.addEventListener('click', function() {
                    // Si es filtro de dificultad
                    if (this.hasAttribute('data-difficulty')) {
                        document.querySelectorAll('.category-pill[data-difficulty]').forEach(p => p.classList.remove('active'));
                        this.classList.add('active');
                        currentDifficulty = this.getAttribute('data-difficulty');
                    }
                });
            });
            
            // Monitorear cambios en formulario para vista previa
            document.getElementById('youtube_id').addEventListener('input', updateVideoPreview);
            document.getElementById('title').addEventListener('input', updateVideoPreview);
            document.getElementById('category_id').addEventListener('change', updateVideoPreview);
            document.getElementById('difficulty_level').addEventListener('change', updateVideoPreview);
            
            // Escuchar la tecla Enter en el campo de b√∫squeda
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchVideos();
                }
            });
            
            // MODIFICADO: Manejar cierre del modal de vista previa
            document.getElementById('previewModal').addEventListener('hidden.bs.modal', function () {
                // Detener cualquier temporizador activo
                if (activeVideoTimer !== null) {
                    clearTimeout(activeVideoTimer);
                    activeVideoTimer = null;
                }
                
                // Detener la reproducci√≥n del video
                document.getElementById('previewIframe').src = '';
                
                // Quitar resaltados
                resetTechniqueHighlights();
                
                // Limpiar variables del video actual
                currentVideoId = null;
                currentVideoTitle = '';
            });

            // NUEVO: Manejar cierre del modal de pinturas
            document.getElementById('paintsModal').addEventListener('hidden.bs.modal', function () {
                // Si se abri√≥ desde preview, no hacer nada especial
                // El modal de preview debe permanecer abierto
                if (isOpenedFromPreview) {
                    isOpenedFromPreview = false; // Resetear el flag
                    // No cerrar el modal de preview
                } else {
                    // Si se abri√≥ normalmente, limpiar variables
                    currentVideoId = null;
                    currentVideoTitle = '';
                }
            });
            
            // Cargar videos al inicio
            fetchVideos()
                .then(() => {
                    console.log('‚úÖ Videos cargados, iniciando lazy loading...');
                    setTimeout(() => {
                        initializeVideoLazyLoading();
                    }, 200);
                })
                .catch(error => {
                    console.error('‚ùå Error al cargar videos:', error);
                });
            loadStatistics();
        });

        // Funci√≥n para inicializar el reproductor de YouTube
        function initYouTubePlayer(videoId) {
            // Si ya existe un reproductor, destruirlo primero
            if (youtubePlayer) {
                youtubePlayer.destroy();
            }
            
            // Crear un nuevo reproductor
            youtubePlayer = new YT.Player('techniquesVideoPreview', {
                videoId: videoId,
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // Funci√≥n que se ejecuta cuando el reproductor est√° listo
        function onPlayerReady(event) {
            console.log('Reproductor de YouTube listo');
        }

        // Funci√≥n que se ejecuta cuando cambia el estado del reproductor
        function onPlayerStateChange(event) {
            // Puedes realizar acciones seg√∫n el estado del reproductor aqu√≠
        }
        
        // Funci√≥n para inicializar tooltips
        function initTooltips() {
            // Destruir tooltips existentes para evitar duplicados
            destroyTooltips();
            
            // Crear nuevos tooltips
            tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                .map(function (el) {
                    return new bootstrap.Tooltip(el);
                });
        }
        
        // Funci√≥n para destruir tooltips existentes
        function destroyTooltips() {
            tooltips.forEach(tooltip => {
                if (tooltip && tooltip.dispose) {
                    tooltip.dispose();
                }
            });
            tooltips = [];
        }
        
        // Funci√≥n para actualizar vista previa del video
        function updateVideoPreview() {
            const youtubeId = document.getElementById('youtube_id').value.trim();
            const title = document.getElementById('title').value.trim();
            const categoryId = document.getElementById('category_id').value;
            const categoryName = categoryId ? 
                document.getElementById('category_id').options[document.getElementById('category_id').selectedIndex].text : 
                'Sin categor√≠a';
            const difficultyLevel = document.getElementById('difficulty_level').value;
            
            // Actualizar miniatura
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            
            if (youtubeId) {
                thumbnailPreview.style.backgroundImage = `url(https://img.youtube.com/vi/${youtubeId}/mqdefault.jpg)`;
                thumbnailPreview.innerHTML = '';
            } else {
                thumbnailPreview.style.backgroundImage = 'none';
                thumbnailPreview.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <span class="text-muted">Ingresa el ID de YouTube para ver la miniatura</span>
                    </div>
                `;
            }
            
            // Actualizar datos del video
            const videoDataPreview = document.getElementById('videoDataPreview');
            
            if (title || youtubeId) {
                let difficultyBadge = '';
                switch(difficultyLevel) {
                    case 'beginner':
                        difficultyBadge = '<span class="badge bg-success">Principiante</span>';
                        break;
                    case 'intermediate':
                        difficultyBadge = '<span class="badge bg-warning text-dark">Intermedio</span>';
                        break;
                    case 'expert':
                        difficultyBadge = '<span class="badge bg-danger">Experto</span>';
                        break;
                }
                
                videoDataPreview.innerHTML = `
                    <h5>${title || 'Sin t√≠tulo'}</h5>
                    <p class="text-muted">${youtubeId ? `YouTube ID: ${youtubeId}` : 'Sin ID de YouTube'}</p>
                    <div>
                        <span class="badge bg-secondary">${categoryName}</span>
                        ${difficultyBadge}
                    </div>
                `;
            } else {
                videoDataPreview.innerHTML = `
                    <p class="text-muted">Ingresa la informaci√≥n del video para ver una vista previa.</p>
                `;
            }
        }
        
        // Funci√≥n para capturar el tiempo actual del video
        function captureCurrentTime() {
            if (youtubePlayer && youtubePlayer.getCurrentTime) {
                // Obtener el tiempo actual en segundos
                const currentTime = Math.floor(youtubePlayer.getCurrentTime());
                
                // Determinar si estamos capturando el tiempo de inicio o final
                const activeInput = document.activeElement;
                
                if (activeInput) {
                    // Convertir a minutos y segundos
                    const minutes = Math.floor(currentTime / 60);
                    const seconds = currentTime % 60;
                    
                    // Establecer los valores en el formulario seg√∫n el campo activo o √∫ltimo campo enfocado
                    if (activeInput.id === 'technique_start_min' || activeInput.id === 'technique_start_sec') {
                        document.getElementById('technique_start_min').value = minutes;
                        document.getElementById('technique_start_sec').value = seconds;
                        document.getElementById('technique_start').value = currentTime;
                    } else if (activeInput.id === 'technique_end_min' || activeInput.id === 'technique_end_sec') {
                        document.getElementById('technique_end_min').value = minutes;
                        document.getElementById('technique_end_sec').value = seconds;
                        document.getElementById('technique_end').value = currentTime;
                    } else {
                        // Si ning√∫n campo est√° enfocado, preguntar al usuario
                        const targetField = confirm('¬øDeseas capturar este tiempo como inicio de la t√©cnica? (OK para inicio, Cancelar para fin)');
                        
                        if (targetField) {
                            // Tiempo inicio
                            document.getElementById('technique_start_min').value = minutes;
                            document.getElementById('technique_start_sec').value = seconds;
                            document.getElementById('technique_start').value = currentTime;
                        } else {
                            // Tiempo fin
                            document.getElementById('technique_end_min').value = minutes;
                            document.getElementById('technique_end_sec').value = seconds;
                            document.getElementById('technique_end').value = currentTime;
                        }
                    }
                    
                    // Mostrar mensaje de confirmaci√≥n
                    document.getElementById('techniqueTiming').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i> Tiempo capturado: ${minutes}:${seconds.toString().padStart(2, '0')}
                        </div>
                    `;
                }
            } else {
                alert('No se pudo capturar el tiempo actual. Aseg√∫rate de que el video est√© cargado correctamente.');
            }
        }
        
        // Funci√≥n para obtener todos los videos
        async function fetchVideos() {
            const container = document.getElementById('videos-container');
            container.innerHTML = `
                <div class="empty-message">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Cargando videos...</p>
                </div>
            `;
            
            try {
                // A√±adido console.log para depuraci√≥n
                console.log("Iniciando solicitud a /api/videos");
                
                const response = await fetch('/api/videos');
                
                console.log("Respuesta recibida:", response.status);
                
                // Verificar si la respuesta es correcta
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
                
                // Intentar convertir la respuesta a JSON
                let data;
                try {
                    data = await response.json();
                    console.log("Datos recibidos:", data);
                } catch (jsonError) {
                    console.error("Error al parsear JSON:", jsonError);
                    throw new Error("Error al procesar los datos del servidor. Respuesta no v√°lida.");
                }
                
                // Verificar que los datos son un array
                if (!Array.isArray(data)) {
                    console.error("Los datos recibidos no son un array:", data);
                    throw new Error("Formato de datos incorrecto. Se esperaba un array de videos.");
                }
                
                console.log(`Videos cargados: ${data.length}`);
                
                // Actualizar la variable global
                allVideos = data;
                
                // Actualizar contador
                if (document.getElementById('videoCount')) {
                    document.getElementById('videoCount').textContent = data.length;
                }
                
                // Mostrar videos
                displayVideos(data);
                
                // Devolver los datos para poder usar .then()
                return data;
                
            } catch (error) {
                console.error('Error al cargar videos:', error);
                container.innerHTML = `
                    <div class="empty-message">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i> Error al cargar los videos: ${error.message}
                        </div>
                        <button class="btn btn-primary mt-3" onclick="fetchVideos()">
                            <i class="bi bi-arrow-clockwise me-2"></i> Intentar de nuevo
                        </button>
                    </div>
                `;
                throw error;
            }
        }
        
        // Funci√≥n para mostrar los videos en la p√°gina
        function displayVideos(videos) {
            const container = document.getElementById('videos-container');
            container.innerHTML = '';
            
            if (videos.length === 0) {
                container.innerHTML = `
                    <div class="empty-message">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i> No se encontraron videos que coincidan con tu b√∫squeda.
                        </div>
                        <button class="btn btn-outline-secondary mt-3" onclick="clearFilters()">
                            <i class="bi bi-funnel me-2"></i> Limpiar filtros
                        </button>
                    </div>
                `;
                return;
            }
            
            if (viewMode === 'grid') {
                displayVideosAsGrid(videos, container);
            } else {
                displayVideosAsList(videos, container);
            }
            
            // Reinicializar los tooltips despu√©s de agregar nuevos elementos
            initTooltips();
            
            // Inicializar lazy loading despu√©s de renderizar los videos
            setTimeout(() => {
                initializeVideoLazyLoading();
            }, 100);
        }
        
        // Funci√≥n para mostrar videos en formato de cuadr√≠cula
        function displayVideosAsGrid(videos, container) {
            videos.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-container';
                videoCard.setAttribute('data-id', video.id);
                
                // Badge para dificultad
                let difficultyText, difficultyClass;
                switch(video.difficulty_level) {
                    case 'beginner':
                        difficultyText = 'Principiante';
                        difficultyClass = 'badge-beginner';
                        break;
                    case 'intermediate':
                        difficultyText = 'Intermedio';
                        difficultyClass = 'badge-intermediate';
                        break;
                    case 'expert':
                        difficultyText = 'Experto';
                        difficultyClass = 'badge-expert';
                        break;
                    default:
                        difficultyText = 'Principiante';
                        difficultyClass = 'badge-beginner';
                }
                
                // Determinar si tiene t√©cnicas
                const hasTechniques = video.techniques && video.techniques.length > 0;
                
                videoCard.innerHTML = `
                    <div class="position-relative">
                        <div class="youtube-container">
                            <img 
                                class="lazy-load-video" 
                                data-video-id="${video.video_id}"
                                data-src="https://img.youtube.com/vi/${video.video_id}/mqdefault.jpg"
                                src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2FhYSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhcmdhbmRvIHZpZGVvLi4uPC90ZXh0Pjwvc3ZnPg=="
                                alt="${video.title}"
                                style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                                onclick="playVideo(this, '${video.video_id}')"
                            />
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;">
                                <i class="bi bi-play-circle-fill" style="font-size: 3rem; color: rgba(255,255,255,0.8); text-shadow: 0 0 10px rgba(0,0,0,0.5);"></i>
                            </div>
                        </div>
                        <div class="video-actions">
                            <i class="bi bi-eye action-icon" onclick="openPreview('${video.video_id}', ${video.id}, \`${video.title}\`)" data-bs-toggle="tooltip" title="Vista previa"></i>
                            <i class="bi bi-pencil action-icon" onclick="editVideo(${video.id})" data-bs-toggle="tooltip" title="Editar"></i>
                            <i class="bi bi-trash action-icon" onclick="confirmDelete(${video.id})" data-bs-toggle="tooltip" title="Eliminar"></i>
                            <i class="bi bi-list-check action-icon" onclick="goToTechniques(${video.id})" data-bs-toggle="tooltip" title="Gestionar t√©cnicas"></i>
                            <i class="bi bi-palette action-icon" onclick="openPaintsModal(${video.id}, \`${video.title}\`)" data-bs-toggle="tooltip" title="Gestionar pinturas"></i>
                            <i class="bi bi-files action-icon" onclick="openCloneModal(${video.id}, \`${video.title}\`, '${video.difficulty_level}')" data-bs-toggle="tooltip" title="Clonar para otro nivel"></i>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="video-title">${video.title}</div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="video-selector form-check-input" onclick="toggleVideoSelection(${video.id})">
                        </div>
                    </div>
                    <div>
                        <span class="badge bg-secondary">${video.category || 'Sin categor√≠a'}</span>
                        <span class="badge ${difficultyClass}">${difficultyText}</span>
                        ${hasTechniques ? '<span class="badge bg-info ms-1"><i class="bi bi-check-circle me-1"></i> ' + video.techniques.length + ' t√©cnicas</span>' : ''}
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Canal: ${video.channel || 'No especificado'}</small>
                    </div>
                `;
                
                container.appendChild(videoCard);
            });
        }
        
        // Funci√≥n para mostrar videos en formato de lista
        function displayVideosAsList(videos, container) {
            const table = document.createElement('table');
            table.className = 'table table-striped table-hover';
            
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th><input type="checkbox" class="form-check-input" id="selectAllVideos" onclick="toggleAllVideos()"></th>
                    <th>Miniatura</th>
                    <th>T√≠tulo</th>
                    <th>Categor√≠a</th>
                    <th>Dificultad</th>
                    <th>T√©cnicas</th>
                    <th>Acciones</th>
                </tr>
            `;
            
            const tbody = document.createElement('tbody');
            
            videos.forEach(video => {
                // Badge para dificultad
                let difficultyText, difficultyClass;
                switch(video.difficulty_level) {
                    case 'beginner':
                        difficultyText = 'Principiante';
                        difficultyClass = 'badge-beginner';
                        break;
                    case 'intermediate':
                        difficultyText = 'Intermedio';
                        difficultyClass = 'badge-intermediate';
                        break;
                    case 'expert':
                        difficultyText = 'Experto';
                        difficultyClass = 'badge-expert';
                        break;
                    default:
                        difficultyText = 'Principiante';
                        difficultyClass = 'badge-beginner';
                }
                
                // Determinar si tiene t√©cnicas
                const hasTechniques = video.techniques && video.techniques.length > 0;
                
                const row = document.createElement('tr');
                row.setAttribute('data-id', video.id);
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input video-selector" onclick="toggleVideoSelection(${video.id})">
                    </td>
                    <td>
                        <img 
                            class="lazy-load-video"
                            data-video-id="${video.video_id}"
                            data-src="https://img.youtube.com/vi/${video.video_id}/mqdefault.jpg"
                            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjY4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiMzMzMiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEwIiBmaWxsPSIjYWFhIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Q2FyZ2FuZG8uLi48L3RleHQ+PC9zdmc+"
                            alt="${video.title}" 
                            style="width: 120px; border-radius: 4px; cursor: pointer;"
                            onclick="playVideo(this, '${video.video_id}')"
                        >
                    </td>
                    <td>
                        <strong>${video.title}</strong>
                        <div class="small text-muted">ID: ${video.video_id}</div>
                        <div class="small text-muted">Canal: ${video.channel || 'No especificado'}</div>
                    </td>
                    <td><span class="badge bg-secondary">${video.category || 'Sin categor√≠a'}</span></td>
                    <td><span class="badge ${difficultyClass}">${difficultyText}</span></td>
                    <td>
                        ${hasTechniques ? '<span class="badge bg-info">' + video.techniques.length + ' t√©cnicas</span>' : '<span class="text-muted">Sin t√©cnicas</span>'}
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="openPreview('${video.video_id}', ${video.id}, \`${video.title}\`)" title="Vista previa">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="editVideo(${video.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="goToTechniques(${video.id})" title="T√©cnicas">
                                <i class="bi bi-list-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="openPaintsModal(${video.id}, \`${video.title}\`)" title="Pinturas">
                                <i class="bi bi-palette"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${video.id})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);
        }
        
        // Funci√≥n para seleccionar/deseleccionar un video
        function toggleVideoSelection(videoId) {
            if (selectedVideos.has(videoId)) {
                selectedVideos.delete(videoId);
            } else {
                selectedVideos.add(videoId);
            }
            
            updateBatchActions();
        }
        
        // Funci√≥n para seleccionar/deseleccionar todos los videos
        function toggleAllVideos() {
            const selectAllCheckbox = document.getElementById('selectAllVideos');
            const videoCheckboxes = document.querySelectorAll('.video-selector');
            
            if (selectAllCheckbox.checked) {
                // Seleccionar todos
                videoCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    const videoId = parseInt(checkbox.closest('[data-id]').getAttribute('data-id'));
                    selectedVideos.add(videoId);
                });
            } else {
                // Deseleccionar todos
                videoCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectedVideos.clear();
            }
            
            updateBatchActions();
        }
        
        // Funci√≥n para actualizar acciones por lote
        function updateBatchActions() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');
            
            selectedCount.textContent = selectedVideos.size;
            
            if (selectedVideos.size > 0) {
                batchActions.style.display = 'block';
            } else {
                batchActions.style.display = 'none';
            }
        }
        
        // Funci√≥n para limpiar la selecci√≥n
        function clearSelection() {
            selectedVideos.clear();
            
            // Desmarcar todos los checkboxes
            document.querySelectorAll('.video-selector').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Ocultar acciones por lote
            document.getElementById('batchActions').style.display = 'none';
        }
        
        // Funci√≥n para eliminar videos seleccionados
        function deleteSelectedVideos() {
            if (selectedVideos.size === 0) return;
            
            if (confirm(`¬øEst√°s seguro de que deseas eliminar ${selectedVideos.size} videos? Esta acci√≥n no se puede deshacer.`)) {
                // Convertir Set a Array para iterar
                const videosToDelete = Array.from(selectedVideos);
                
                // Contador para seguimiento
                let deleted = 0;
                let errors = 0;
                
                // Funci√≥n para eliminar un video y continuar con el siguiente
                const deleteNext = (index) => {
                    if (index >= videosToDelete.length) {
                        // Todos los videos procesados
                        fetchVideos();
                        loadStatistics();
                        clearSelection();
                        alert(`Eliminaci√≥n completada: ${deleted} videos eliminados, ${errors} errores.`);
                        return;
                    }
                    
                    const videoId = videosToDelete[index];
                    
                    fetch(`/admin/videos/${videoId}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (response.ok) {
                            deleted++;
                        } else {
                            errors++;
                            console.error(`Error al eliminar video ID ${videoId}`);
                        }
                        // Continuar con el siguiente video
                        deleteNext(index + 1);
                    })
                    .catch(error => {
                        errors++;
                        console.error(`Error al eliminar video ID ${videoId}:`, error);
                        // Continuar con el siguiente video
                        deleteNext(index + 1);
                    });
                };
                
                // Comenzar el proceso de eliminaci√≥n
                deleteNext(0);
            }
        }
        
        // Funci√≥n para filtrar videos
        function filterVideos() {
            let filteredVideos = [...allVideos];
            
            // Filtrar por t√©rmino de b√∫squeda
            if (currentSearchTerm) {
                filteredVideos = filteredVideos.filter(video => {
                    return (
                        (video.title && video.title.toLowerCase().includes(currentSearchTerm)) ||
                        (video.description && video.description.toLowerCase().includes(currentSearchTerm)) ||
                        (video.channel && video.channel.toLowerCase().includes(currentSearchTerm))
                    );
                });
            }
            
            // Filtrar por categor√≠a
            if (currentCategory !== 'all') {
                filteredVideos = filteredVideos.filter(video => 
                    (video.category || 'Sin categor√≠a') === currentCategory
                );
            }
            
            // Filtrar por dificultad
            if (currentDifficulty !== 'all') {
                filteredVideos = filteredVideos.filter(video => 
                    video.difficulty_level === currentDifficulty
                );
            }
            
            // Filtrar por videos con/sin t√©cnicas
            const filterHasTechniques = document.getElementById('filterHasTechniques').checked;
            const filterNoTechniques = document.getElementById('filterNoTechniques').checked;
            
            if (filterHasTechniques && !filterNoTechniques) {
                filteredVideos = filteredVideos.filter(video => 
                    video.techniques && video.techniques.length > 0
                );
            } else if (!filterHasTechniques && filterNoTechniques) {
                filteredVideos = filteredVideos.filter(video => 
                    !video.techniques || video.techniques.length === 0
                );
            }
            
            // Actualizar contador de videos
            if (document.getElementById('videoCount')) {
                document.getElementById('videoCount').textContent = filteredVideos.length;
            }
            
            // Mostrar videos filtrados
            displayVideos(filteredVideos);
        }
        
        // Funci√≥n para buscar videos
        function searchVideos() {
            currentSearchTerm = document.getElementById('searchInput').value.toLowerCase();
            updateActiveFilters();
            filterVideos();
        }
        
        // MODIFICADA: Funci√≥n para abrir vista previa con soporte para pinturas
        async function openPreview(videoId, id, title) {
            // Establecer variables globales para el video actual
            currentVideoId = id;
            currentVideoTitle = title;
            
            const iframe = document.getElementById('previewIframe');
            iframe.src = `https://www.youtube.com/embed/${videoId}`;
            
            // Actualizar t√≠tulo en el modal
            document.getElementById('previewVideoTitle').textContent = title;
            
            // Cargar t√©cnicas
            try {
                const response = await fetch(`/api/videos/${id}/techniques`);
                if (!response.ok) {
                    throw new Error('Error al cargar t√©cnicas');
                }
                
                const techniques = await response.json();
                const techniquesList = document.getElementById('previewTechniques');
                
                if (techniques.length === 0) {
                    techniquesList.innerHTML = '<div class="alert alert-info">No hay t√©cnicas registradas para este video.</div>';
                } else {
                    techniquesList.innerHTML = '';
                    techniques.sort((a, b) => a.start_time - b.start_time);
                    techniques.forEach(technique => {
                        const startTime = formatTime(technique.start_time);
                        const endTime = formatTime(technique.end_time);
                        
                        const item = document.createElement('div');
                        item.className = 'technique-item';
                        item.innerHTML = `
                            <div class="technique-content">
                                <strong>${technique.name}</strong> - 
                                <span class="time-selector" onclick="playTechniqueSegment('${videoId}', ${technique.start_time}, ${technique.end_time}); highlightTechnique(this.closest('.technique-item'))">
                                    <i class="bi bi-clock"></i> <span class="time-text">${startTime} - ${endTime}</span>
                                </span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="playTechniqueSegment('${videoId}', ${technique.start_time}, ${technique.end_time}); highlightTechnique(this.closest('.technique-item'))">
                                <i class="bi bi-play-fill"></i> Ver t√©cnica
                            </button>
                        `;
                        
                        techniquesList.appendChild(item);
                    });
                }
                
                previewModal.show();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('previewTechniques').innerHTML = 
                    `<div class="alert alert-danger">Error al cargar t√©cnicas: ${error.message}</div>`;
                previewModal.show();
            }
        }

        // Funci√≥n para navegar a la pesta√±a de t√©cnicas
        function goToTechniques(videoId) {
            // Guardar el ID del video
            document.getElementById('technique_video_id').value = videoId;
            
            // Cargar las t√©cnicas del video
            loadTechniques(videoId);
            
            // Mostrar la pesta√±a de t√©cnicas
            document.getElementById('techniques-tab').style.display = 'block';
            document.getElementById('techniques-tab').click();
            
            // Cargar el video para la vista previa
            loadVideoForTechniques(videoId);
        }
        
        // Funci√≥n para cargar el video en la pesta√±a de t√©cnicas
        async function loadVideoForTechniques(videoId) {
            try {
                const response = await fetch(`/admin/videos/${videoId}`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar datos del video');
                }
                
                const video = await response.json();
                
                // Actualizar t√≠tulo del video
                document.getElementById('videoTitleDisplay').textContent = video.title;
                
                // Guardar el YouTube ID para usarlo con el API
                document.getElementById('currentYoutubeId').value = video.video_id;
                
                // Inicializar el reproductor de YouTube despu√©s de que la API est√© lista
                if (window.YT && window.YT.Player) {
                    initYouTubePlayer(video.video_id);
                } else {
                    // Si la API de YouTube a√∫n no est√° lista, esperar a que se cargue
                    window.onYouTubeIframeAPIReady = function() {
                        initYouTubePlayer(video.video_id);
                    };
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error al cargar el video: ${error.message}`);
            }
        }
        
        // Funci√≥n para formatear tiempo en segundos a MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Funci√≥n para volver a la pesta√±a de videos
        function goBackToVideos() {
            document.getElementById('video-list-tab').click();
            document.getElementById('techniques-tab').style.display = 'none';
        }
        
        // Funci√≥n para finalizar la edici√≥n de t√©cnicas
        function finishEditingTechniques() {
            // Ocultar la pesta√±a de t√©cnicas
            document.getElementById('techniques-tab').style.display = 'none';
            
            // Volver a la pesta√±a de videos
            document.getElementById('video-list-tab').click();
            
            // Recargar los videos para reflejar los cambios
            fetchVideos();
            loadStatistics();
        }
        
        // Funci√≥n para confirmar eliminaci√≥n
        function confirmDelete(id) {
            videoToDelete = id;
            confirmDeleteModal.show();
        }
        
        // Funci√≥n para eliminar video
        async function deleteVideo(id) {
            try {
                const response = await fetch(`/admin/videos/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Error al eliminar el video');
                }
                
                // Recargar lista de videos
                fetchVideos();
                loadStatistics();
                
                // Mostrar mensaje de √©xito
                alert('Video eliminado correctamente');
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error al eliminar el video: ${error.message}`);
            }
        }
        
        // Funci√≥n para editar video
        async function editVideo(id) {
            try {
                const response = await fetch(`/admin/videos/${id}`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar datos del video');
                }
                
                const video = await response.json();
                
                // Cambiar a la pesta√±a de a√±adir/editar
                document.getElementById('add-video-tab').click();
                
                // Llenar formulario
                document.getElementById('video_id_edit').value = video.id;
                document.getElementById('title').value = video.title;
                document.getElementById('youtube_id').value = video.video_id;
                document.getElementById('description').value = video.description || '';
                document.getElementById('channel').value = video.channel || '';
                
                // Seleccionar categor√≠a si existe
                if (video.category_id) {
                    document.getElementById('category_id').value = video.category_id;
                } else {
                    document.getElementById('category_id').value = '';
                }
                
                document.getElementById('difficulty_level').value = video.difficulty_level || 'beginner';
                
                // Actualizar los campos de tiempo en formato MM:SS
                const startTimeMin = document.getElementById('technique_start_time_min');
                const startTimeSec = document.getElementById('technique_start_time_sec');
                const endTimeMin = document.getElementById('technique_end_time_min');
                const endTimeSec = document.getElementById('technique_end_time_sec');
                const startTimeHidden = document.getElementById('technique_start_time');
                const endTimeHidden = document.getElementById('technique_end_time');
                
                // Convertir segundos a formato MM:SS
                if (video.technique_start_time !== null && video.technique_start_time !== undefined) {
                    secondsToMinSec(video.technique_start_time, startTimeMin, startTimeSec);
                    startTimeHidden.value = video.technique_start_time;
                }
                
                if (video.technique_end_time !== null && video.technique_end_time !== undefined) {
                    secondsToMinSec(video.technique_end_time, endTimeMin, endTimeSec);
                    endTimeHidden.value = video.technique_end_time;
                }
                
                // Actualizar vista previa
                updateVideoPreview();
                
                // Cambiar texto del formulario
                document.getElementById('form-title').textContent = 'Editar Video';
                document.getElementById('submit-btn').textContent = 'Actualizar Video';
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error al cargar datos del video: ${error.message}`);
            }
        }
        
        // Funci√≥n para cargar t√©cnicas de un video
        async function loadTechniques(videoId) {
            try {
                const response = await fetch(`/api/videos/${videoId}/techniques`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar t√©cnicas');
                }
                
                const techniques = await response.json();
                const techniquesList = document.getElementById('techniques-list');
                
                if (techniques.length === 0) {
                    techniquesList.innerHTML = '<div class="alert alert-info">No hay t√©cnicas asociadas a este video.</div>';
                    return;
                }
                
                // Obtener primero los datos del video para tener el ID de YouTube
                const videoResponse = await fetch(`/admin/videos/${videoId}`);
                if (!videoResponse.ok) {
                    throw new Error('Error al cargar datos del video');
                }
                const videoData = await videoResponse.json();
                const videoYoutubeId = videoData.video_id;
                
                techniquesList.innerHTML = '';
                
                // Ahora recorremos las t√©cnicas para mostrarlas
                for (const technique of techniques) {
                    const item = document.createElement('div');
                    item.className = 'technique-item';
                    
                    const startTime = formatTime(technique.start_time);
                    const endTime = formatTime(technique.end_time);
                    
                    item.innerHTML = `
                        <div class="technique-content">
                            <strong>${technique.name}</strong> - 
                            <span class="time-selector" onclick="playSegmentInTechniquesTab('${videoYoutubeId}', ${technique.start_time}, ${technique.end_time}); highlightTechnique(this.closest('.technique-item'))">
                                <i class="bi bi-clock"></i> <span class="time-text">${startTime} - ${endTime}</span>
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="playSegmentInTechniquesTab('${videoYoutubeId}', ${technique.start_time}, ${technique.end_time}); highlightTechnique(this.closest('.technique-item'))">
                                <i class="bi bi-play-fill"></i> Ver
                            </button>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editTechnique(${technique.id}, '${technique.name}', ${technique.start_time}, ${technique.end_time})">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTechnique(${technique.id})">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                    
                    techniquesList.appendChild(item);
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('techniques-list').innerHTML = 
                    `<div class="alert alert-danger">Error al cargar t√©cnicas: ${error.message}</div>`;
            }
        }
        
        // Funci√≥n para reproducir un segmento en la pesta√±a de t√©cnicas
        function playSegmentInTechniquesTab(videoId, startTime, endTime) {
            if (youtubePlayer && youtubePlayer.loadVideoById) {
                // Cargar el video en el tiempo espec√≠fico
                youtubePlayer.loadVideoById({
                    videoId: videoId,
                    startSeconds: startTime
                });
                
                // Mostrar informaci√≥n del tiempo
                document.getElementById('techniqueTiming').innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-play-fill me-2"></i> Reproduciendo desde ${formatTime(startTime)} hasta ${formatTime(endTime)}
                    </div>
                `;
                
                // Si hay un temporizador activo, limpiarlo
                if (window.activeSegmentTimer) {
                    clearTimeout(window.activeSegmentTimer);
                }
                
                // Establecer un temporizador para detener el video cuando llegue al final del segmento
                window.activeSegmentTimer = setTimeout(() => {
                    youtubePlayer.pauseVideo();
                }, (endTime - startTime) * 1000);
            } else {
                // Si el reproductor no est√° disponible, usar el iframe tradicional
                const iframe = document.getElementById('techniquesVideoPreview');
                if (iframe) {
                    const containerDiv = iframe.parentElement;
                    containerDiv.innerHTML = `<iframe id="techniquesVideoPreview" src="https://www.youtube.com/embed/${videoId}?start=${startTime}&autoplay=1" frameborder="0" allowfullscreen></iframe>`;
                    
                    // Mostrar informaci√≥n del tiempo
                    document.getElementById('techniqueTiming').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-play-fill me-2"></i> Reproduciendo desde ${formatTime(startTime)} hasta ${formatTime(endTime)}
                        </div>
                    `;
                }
            }
        }
        
        // Funci√≥n para resaltar la t√©cnica que se est√° reproduciendo
        function highlightTechnique(techniqueElement) {
            // Quitar el resaltado de todas las t√©cnicas
            resetTechniqueHighlights();
            
            // A√±adir clase de resaltado a la t√©cnica actual
            if (techniqueElement) {
                techniqueElement.classList.add('technique-highlight');
            }
        }
        
        // Funci√≥n para quitar todos los resaltados de t√©cnicas
        function resetTechniqueHighlights() {
            document.querySelectorAll('.technique-item').forEach(el => {
                el.classList.remove('technique-highlight');
            });
        }
        
        // Funci√≥n para reproducir un segmento espec√≠fico en la vista previa
        function playTechniqueSegment(videoId, startTime, endTime) {
            // Detener cualquier temporizador activo
            if (activeVideoTimer !== null) {
                clearTimeout(activeVideoTimer);
                activeVideoTimer = null;
            }
            
            // Obtener el iframe del video
            const iframe = document.getElementById('previewIframe');
            if (iframe) {
                // Actualizar la URL con los par√°metros de tiempo y autoplay
                iframe.src = `https://www.youtube.com/embed/${videoId}?start=${startTime}&autoplay=1`;
                
                // Calcular la duraci√≥n de la t√©cnica
                const duration = endTime - startTime;
                
                // Configurar un temporizador para detener el video despu√©s de que termine la t√©cnica
                activeVideoTimer = setTimeout(() => {
                    // Resetear el video
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    activeVideoTimer = null;
                }, duration * 1000);
            }
        }
        
        // Funci√≥n para editar t√©cnica
        function editTechnique(id, name, startTime, endTime) {
            document.getElementById('technique_id_edit').value = id;
            document.getElementById('technique_name').value = name;
            
            // Convertir segundos a formato MM:SS
            const startMin = document.getElementById('technique_start_min');
            const startSec = document.getElementById('technique_start_sec');
            const endMin = document.getElementById('technique_end_min');
            const endSec = document.getElementById('technique_end_sec');
            const startHidden = document.getElementById('technique_start');
            const endHidden = document.getElementById('technique_end');
            
            secondsToMinSec(startTime, startMin, startSec);
            secondsToMinSec(endTime, endMin, endSec);
            
            startHidden.value = startTime;
            endHidden.value = endTime;
            
            // Cambiar texto del bot√≥n
            document.getElementById('technique-submit-btn').textContent = 'Actualizar T√©cnica';
            
            // Desplazarse al formulario
            document.getElementById('techniqueForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Funci√≥n para eliminar t√©cnica
        async function deleteTechnique(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta t√©cnica?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/techniques/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Error al eliminar la t√©cnica');
                }
                
                // Recargar t√©cnicas
                const videoId = document.getElementById('technique_video_id').value;
                loadTechniques(videoId);
                
                // Mostrar mensaje de √©xito
                alert('T√©cnica eliminada correctamente');
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error al eliminar la t√©cnica: ${error.message}`);
            }
        }
        
        // Funci√≥n para guardar/actualizar video
        async function saveVideo() {
            const videoId = document.getElementById('video_id_edit').value;
            const isEdit = videoId !== '';
            
            // Extraer el ID de YouTube de la URL
            let youtubeInputValue = document.getElementById('youtube_id').value.trim();
            let youtubeVideoId = youtubeInputValue;
            
            // Si es una URL completa, extraer solo el ID
            if (youtubeInputValue.includes('youtube.com/watch?v=')) {
                const url = new URL(youtubeInputValue);
                youtubeVideoId = url.searchParams.get('v');
            } else if (youtubeInputValue.includes('youtu.be/')) {
                youtubeVideoId = youtubeInputValue.split('youtu.be/')[1];
            }
            
            // Si hay par√°metros adicionales despu√©s del ID, eliminarlos
            if (youtubeVideoId && youtubeVideoId.includes('&')) {
                youtubeVideoId = youtubeVideoId.split('&')[0];
            }
            
            const categoryId = document.getElementById('category_id').value;
            const categoryName = categoryId ? 
                document.getElementById('category_id').options[document.getElementById('category_id').selectedIndex].text : 
                'Sin categor√≠a';
            
            const videoData = {
                title: document.getElementById('title').value,
                video_id: youtubeVideoId,
                description: document.getElementById('description').value,
                channel: document.getElementById('channel').value,
                category: categoryName,
                category_id: categoryId || null,
                difficulty_level: document.getElementById('difficulty_level').value,
                technique_start_time: parseInt(document.getElementById('technique_start_time').value) || 0
            };
            
            const endTime = document.getElementById('technique_end_time').value;
            if (endTime) {
                videoData.technique_end_time = parseInt(endTime);
            }
            
            try {
                let url = '/admin/videos';
                let method = 'POST';
                
                if (isEdit) {
                    url = `/admin/videos/${videoId}`;
                    method = 'PUT';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(videoData)
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al guardar el video');
                }
                
                const data = await response.json();
                
                // Si es un nuevo video, preguntar si quiere a√±adir t√©cnicas
                if (!isEdit && confirm('Video guardado correctamente. ¬øDeseas a√±adir t√©cnicas a este video ahora?')) {
                    goToTechniques(data.id);
                } else {
                    // Resetear formulario
                    resetForm();
                    
                    // Cambiar a la pesta√±a de videos
                    document.getElementById('video-list-tab').click();
                    
                    // Recargar lista de videos
                    fetchVideos();
                    loadStatistics();
                    
                    // Mostrar mensaje de √©xito
                    alert(isEdit ? 'Video actualizado correctamente' : 'Video guardado correctamente');
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Funci√≥n para guardar/actualizar t√©cnica
        async function saveTechnique() {
            const techniqueId = document.getElementById('technique_id_edit').value;
            const videoId = document.getElementById('technique_video_id').value;
            const isEdit = techniqueId !== '';
            
            if (!videoId) {
                alert('Primero debes seleccionar un video');
                return;
            }
            
            const techniqueData = {
                name: document.getElementById('technique_name').value,
                start_time: parseInt(document.getElementById('technique_start').value),
                end_time: parseInt(document.getElementById('technique_end').value)
            };
            
            try {
                let url, method;
                
                if (isEdit) {
                    url = `/api/techniques/${techniqueId}`;
                    method = 'PUT';
                } else {
                    url = `/api/videos/${videoId}/techniques`;
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(techniqueData)
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al guardar la t√©cnica');
                }
                
                // Resetear formulario de t√©cnica
                resetTechniqueForm();
                
                // Recargar t√©cnicas
                loadTechniques(videoId);
                
                // Mostrar mensaje de √©xito
                alert(isEdit ? 'T√©cnica actualizada correctamente' : 'T√©cnica a√±adida correctamente');
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Funci√≥n para resetear formulario de video
        function resetForm() {
            document.getElementById('videoForm').reset();
            document.getElementById('video_id_edit').value = '';
            document.getElementById('form-title').textContent = 'A√±adir Nuevo Video';
            document.getElementById('submit-btn').textContent = 'Guardar Video';
            
            // Resetear vista previa
            document.getElementById('thumbnailPreview').style.backgroundImage = 'none';
            document.getElementById('thumbnailPreview').innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <span class="text-muted">La miniatura se generar√° autom√°ticamente</span>
                </div>
            `;
            
            document.getElementById('videoDataPreview').innerHTML = `
                <p class="text-muted">Ingresa la informaci√≥n del video para ver una vista previa.</p>
            `;
        }
        
        // Funci√≥n para resetear formulario de t√©cnica
        function resetTechniqueForm() {
            document.getElementById('techniqueForm').reset();
            document.getElementById('technique_id_edit').value = '';
            document.getElementById('technique-submit-btn').textContent = 'A√±adir T√©cnica';
        }
        
        // Funci√≥n para inicializar los campos de tiempo
        function initTimeInputs() {
            // Para el formulario de video principal
            const startTimeMin = document.getElementById('technique_start_time_min');
            const startTimeSec = document.getElementById('technique_start_time_sec');
            const endTimeMin = document.getElementById('technique_end_time_min');
            const endTimeSec = document.getElementById('technique_end_time_sec');
            const startTimeHidden = document.getElementById('technique_start_time');
            const endTimeHidden = document.getElementById('technique_end_time');
            
            // Eventos para convertir minutos:segundos a segundos totales
            [startTimeMin, startTimeSec].forEach(input => {
                input.addEventListener('input', () => {
                    validateAndUpdateTime(startTimeMin, startTimeSec, startTimeHidden);
                    validateTimeRange(startTimeMin, startTimeSec, endTimeMin, endTimeSec);
                });
            });
            
            [endTimeMin, endTimeSec].forEach(input => {
                input.addEventListener('input', () => {
                    validateAndUpdateTime(endTimeMin, endTimeSec, endTimeHidden);
                    validateTimeRange(startTimeMin, startTimeSec, endTimeMin, endTimeSec);
                });
            });
            
            // Para el formulario de t√©cnicas
            const techniqueStartMin = document.getElementById('technique_start_min');
            const techniqueStartSec = document.getElementById('technique_start_sec');
            const techniqueEndMin = document.getElementById('technique_end_min');
            const techniqueEndSec = document.getElementById('technique_end_sec');
            const techniqueStartHidden = document.getElementById('technique_start');
            const techniqueEndHidden = document.getElementById('technique_end');
            
            // Eventos para convertir minutos:segundos a segundos totales
            [techniqueStartMin, techniqueStartSec].forEach(input => {
                input.addEventListener('input', () => {
                    validateAndUpdateTime(techniqueStartMin, techniqueStartSec, techniqueStartHidden);
                    validateTimeRange(techniqueStartMin, techniqueStartSec, techniqueEndMin, techniqueEndSec);
                });
            });
            
            [techniqueEndMin, techniqueEndSec].forEach(input => {
                input.addEventListener('input', () => {
                    validateAndUpdateTime(techniqueEndMin, techniqueEndSec, techniqueEndHidden);
                    validateTimeRange(techniqueStartMin, techniqueStartSec, techniqueEndMin, techniqueEndSec);
                });
            });
        }

        // Funci√≥n para validar y actualizar el tiempo en el campo oculto
        function validateAndUpdateTime(minInput, secInput, hiddenInput) {
            let minutes = parseInt(minInput.value) || 0;
            let seconds = parseInt(secInput.value) || 0;
            
            // Asegurarse de que los segundos est√©n en el rango 0-59
            if (seconds > 59) {
                seconds = 59;
                secInput.value = 59;
            }
            
            // Calcular tiempo total en segundos
            const totalSeconds = minutes * 60 + seconds;
            hiddenInput.value = totalSeconds;
        }

        // Funci√≥n para validar que el tiempo final sea mayor que el inicial
        function validateTimeRange(startMinInput, startSecInput, endMinInput, endSecInput) {
            const startMin = parseInt(startMinInput.value) || 0;
            const startSec = parseInt(startSecInput.value) || 0;
            const endMin = parseInt(endMinInput.value) || 0;
            const endSec = parseInt(endSecInput.value) || 0;
            
            const startTotal = startMin * 60 + startSec;
            const endTotal = endMin * 60 + endSec;
            
            // Validar que el tiempo final sea mayor que el inicial
            if (endTotal <= startTotal && (endMinInput.value !== '' || endSecInput.value !== '')) {
                // Calcular un tiempo final v√°lido (inicial + 10 segundos)
                let newEndTotal = startTotal + 10;
                const newEndMin = Math.floor(newEndTotal / 60);
                const newEndSec = newEndTotal % 60;
                
                endMinInput.value = newEndMin;
                endSecInput.value = newEndSec;
            }
        }

        // Funci√≥n para convertir segundos a formato minutos:segundos y actualizar los campos
        function secondsToMinSec(seconds, minInput, secInput) {
            if (seconds === null || seconds === undefined || seconds === '') return;
            
            const totalSeconds = parseInt(seconds);
            const minutes = Math.floor(totalSeconds / 60);
            const remainingSeconds = totalSeconds % 60;
            
            minInput.value = minutes;
            secInput.value = remainingSeconds;
        }
        
        // Funci√≥n para abrir el modal de clonaci√≥n
        function openCloneModal(videoId, videoTitle, currentDifficulty) {
            // Configurar el formulario
            document.getElementById('cloneForm').action = `/admin/clone-video/${videoId}`;
            document.getElementById('cloneVideoDescription').textContent = 
                `Vas a crear una nueva versi√≥n del video "${videoTitle}" para un nivel de dificultad diferente al actual (${formatDifficultyLevel(currentDifficulty)}).`;
            
            // Eliminar la opci√≥n del nivel actual
            const select = document.getElementById('cloneDifficultyLevel');
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === currentDifficulty) {
                    select.options[i].disabled = true;
                } else {
                    select.options[i].disabled = false;
                }
            }
            
            // Mostrar el modal
            const cloneModal = new bootstrap.Modal(document.getElementById('cloneVideoModal'));
            cloneModal.show();
        }

        // Funci√≥n auxiliar para formatear el nivel de dificultad
        function formatDifficultyLevel(level) {
            switch(level) {
                case 'beginner': return 'Principiante';
                case 'intermediate': return 'Intermedio';
                case 'expert': return 'Experto';
                default: return level;
            }
        }
        
        // Funci√≥n para cargar las categor√≠as disponibles
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                
                if (!response.ok) {
                    throw new Error('Error al cargar categor√≠as');
                }
                
                const categories = await response.json();
                const categorySelect = document.getElementById('category_id');
                const categoryFilter = document.getElementById('categoryFilter');
                
                // Mantener la opci√≥n 'Sin categor√≠a' en el formulario
                categorySelect.innerHTML = '<option value="">Sin categor√≠a</option>';
                
                // Mantener las opciones por defecto en el filtro
                categoryFilter.innerHTML = `
                    <option value="all">Todas las categor√≠as</option>
                    <option value="Sin categor√≠a">Sin categor√≠a</option>  
                `;
                
                // A√±adir las categor√≠as desde la base de datos
                categories.forEach(category => {
                    // Para el formulario
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                    
                    // Para el filtro
                    const filterOption = document.createElement('option');
                    filterOption.value = category.name;
                    filterOption.textContent = category.name;
                    categoryFilter.appendChild(filterOption);
                });
            } catch (error) {
                console.error('Error al cargar categor√≠as:', error);
            }
        }

        // Funci√≥n para limpiar todos los filtros
        function clearFilters() {
            currentSearchTerm = '';
            document.getElementById('searchInput').value = '';
            
            // Resetear categor√≠as - MODIFICADO para usar el select
            document.getElementById('categoryFilter').value = 'all';
            currentCategory = 'all';
            
            // Resetear dificultad
            document.querySelectorAll('.category-pill[data-difficulty]').forEach(pill => {
                pill.classList.remove('active');
            });
            document.querySelector('.category-pill[data-difficulty="all"]').classList.add('active');
            currentDifficulty = 'all';
            
            // Resetear checkboxes
            document.getElementById('filterHasTechniques').checked = false;
            document.getElementById('filterNoTechniques').checked = false;
            
            // Limpiar filtros activos
            document.getElementById('activeFilters').innerHTML = '';
            
            // Resetear la vista
            displayVideos(allVideos);
        }
        
        // Funci√≥n para aplicar los filtros actuales
        function applyFilters() {
            // Actualizar filtros activos
            updateActiveFilters();
            
            // Filtrar videos
            filterVideos();
            
            // Cerrar el collapsible de filtros avanzados
            const bsCollapse = bootstrap.Collapse.getInstance(document.getElementById('advancedFilters'));
            if (bsCollapse) {
                bsCollapse.hide();
            }
        }
        
        // Funci√≥n para actualizar la visualizaci√≥n de filtros activos
        function updateActiveFilters() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            activeFiltersContainer.innerHTML = '';
            
            // Categor√≠a
            if (currentCategory !== 'all') {
                addFilterChip(activeFiltersContainer, 'Categor√≠a: ' + currentCategory, () => {
                    document.getElementById('categoryFilter').value = 'all';
                    currentCategory = 'all';
                    filterVideos();
                });
            }
            
            // Dificultad
            if (currentDifficulty !== 'all') {
                let difficultyText;
                switch(currentDifficulty) {
                    case 'beginner': difficultyText = 'Principiante'; break;
                    case 'intermediate': difficultyText = 'Intermedio'; break;
                    case 'expert': difficultyText = 'Experto'; break;
                    default: difficultyText = currentDifficulty;
                }
                
                addFilterChip(activeFiltersContainer, 'Dificultad: ' + difficultyText, () => {
                    document.querySelectorAll('.category-pill[data-difficulty]').forEach(pill => {
                        pill.classList.remove('active');
                    });
                    document.querySelector('.category-pill[data-difficulty="all"]').classList.add('active');
                    currentDifficulty = 'all';
                    filterVideos();
                });
            }
            
            // Videos con t√©cnicas
            if (document.getElementById('filterHasTechniques').checked) {
                addFilterChip(activeFiltersContainer, 'Solo videos con t√©cnicas', () => {
                    document.getElementById('filterHasTechniques').checked = false;
                    filterVideos();
                });
            }
            
            // Videos sin t√©cnicas
            if (document.getElementById('filterNoTechniques').checked) {
                addFilterChip(activeFiltersContainer, 'Solo videos sin t√©cnicas', () => {
                    document.getElementById('filterNoTechniques').checked = false;
                    filterVideos();
                });
            }
            
            // T√©rmino de b√∫squeda
            if (currentSearchTerm) {
                addFilterChip(activeFiltersContainer, 'B√∫squeda: ' + currentSearchTerm, () => {
                    document.getElementById('searchInput').value = '';
                    currentSearchTerm = '';
                    filterVideos();
                });
            }
        }
        
        // Funci√≥n para a√±adir un chip de filtro
        function addFilterChip(container, text, removeCallback) {
            const chip = document.createElement('div');
            chip.className = 'filter-chip';
            chip.innerHTML = `
                ${text}
                <span class="close" onclick="event.stopPropagation();">&times;</span>
            `;
            
            chip.querySelector('.close').addEventListener('click', () => {
                removeCallback();
                chip.remove();
            });
            
            container.appendChild(chip);
        }

        // MODIFICADA: Funci√≥n para abrir el modal de pinturas con soporte para modal anidado
        async function openPaintsModal(videoId, videoTitle) {
            currentVideoId = videoId;
            currentVideoTitle = videoTitle; // Almacenar el t√≠tulo
            document.getElementById('paintsVideoTitle').textContent = videoTitle;
            
            if (!paintsModal) {
                paintsModal = new bootstrap.Modal(document.getElementById('paintsModal'));
            }
            
            // NUEVO: Configurar z-index para modal anidado si se abre desde preview
            if (isOpenedFromPreview) {
                document.getElementById('paintsModal').style.zIndex = '1070';
                // Crear backdrop secundario
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show secondary-modal';
                backdrop.id = 'paintsModalBackdrop';
                document.body.appendChild(backdrop);
            } else {
                document.getElementById('paintsModal').style.zIndex = '1055';
            }
            
            // Cargar pinturas y asociaciones
            await loadPaintsForModal();
            await loadVideoAssociatedPaints(videoId);
            
            paintsModal.show();
            
            // NUEVO: Configurar eventos para modal anidado
            if (isOpenedFromPreview) {
                document.getElementById('paintsModal').addEventListener('hidden.bs.modal', function removePaintsBackdrop() {
                    const backdrop = document.getElementById('paintsModalBackdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    document.getElementById('paintsModal').removeEventListener('hidden.bs.modal', removePaintsBackdrop);
                }, { once: true });
            }
        }

        // Funci√≥n para cargar todas las pinturas
        async function loadPaintsForModal() {
            try {
                const response = await fetch('/api/paints');
                if (!response.ok) {
                    throw new Error('Error al cargar pinturas');
                }
                
                allPaintsModal = await response.json();
                
                // Cargar marcas para el filtro
                const brands = [...new Set(allPaintsModal.map(paint => paint.brand))].sort();
                const brandSelect = document.getElementById('filterPaintsBrand');
                brandSelect.innerHTML = '<option value="">Todas las marcas</option>';
                brands.forEach(brand => {
                    brandSelect.innerHTML += `<option value="${brand}">${brand}</option>`;
                });
                
                displayPaintsInModal(allPaintsModal);
                
            } catch (error) {
                console.error('Error al cargar pinturas:', error);
                document.getElementById('availablePaintsList').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">Error al cargar pinturas: ${error.message}</div>
                    </div>
                `;
            }
        }

        // Funci√≥n para cargar pinturas ya asociadas al video
        async function loadVideoAssociatedPaints(videoId) {
            try {
                const response = await fetch(`/api/videos/${videoId}/paints`);
                if (response.ok) {
                    const paints = await response.json();
                    associatedPaints = new Set(paints.map(paint => paint.id));
                    displayAssociatedPaints(paints);
                } else {
                    // Si no existe el endpoint, inicializar vac√≠o
                    associatedPaints = new Set();
                    displayAssociatedPaints([]);
                }
            } catch (error) {
                console.error('Error al cargar pinturas asociadas:', error);
                associatedPaints = new Set();
                displayAssociatedPaints([]);
            }
        }

        // Funci√≥n para mostrar las pinturas en el modal
        function displayPaintsInModal(paints) {
            const container = document.getElementById('availablePaintsList');
            
            if (paints.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">No se encontraron pinturas.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            paints.forEach(paint => {
                const isAssociated = associatedPaints.has(paint.id);
                const paintElement = document.createElement('div');
                paintElement.className = 'col-md-6 col-lg-4';
                
                paintElement.innerHTML = `
                    <div class="paint-item ${isAssociated ? 'associated' : ''}" onclick="togglePaintSelection(${paint.id})">
                        <div class="d-flex align-items-center mb-2">
                            <div class="paint-color-circle" style="background-color: ${paint.color_preview || '#cccccc'}"></div>
                            <div class="flex-grow-1">
                                <strong>${paint.name}</strong>
                                <div class="small text-muted">${paint.brand} - ${paint.color_code || 'Sin c√≥digo'}</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" ${isAssociated ? 'checked' : ''} id="paint_${paint.id}">
                            </div>
                        </div>
                        <div class="small">
                            <span class="badge bg-secondary">${paint.color_type || 'Sin tipo'}</span>
                            ${paint.color_family ? `<span class="badge bg-light text-dark">${paint.color_family}</span>` : ''}
                        </div>
                        ${paint.description ? `<div class="small text-muted mt-2">${paint.description}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(paintElement);
            });
        }

        // Funci√≥n para mostrar pinturas asociadas
        function displayAssociatedPaints(paints) {
            const container = document.getElementById('associatedPaintsList');
            const counter = document.getElementById('associatedPaintsCount');
            
            counter.textContent = paints.length;
            
            if (paints.length === 0) {
                container.innerHTML = '<span class="text-muted">Ninguna pintura asociada</span>';
                return;
            }
            
            container.innerHTML = '';
            paints.forEach(paint => {
                const chip = document.createElement('span');
                chip.className = 'associated-paint-chip';
                chip.innerHTML = `
                    ${paint.name} (${paint.brand})
                    <span class="remove-paint" onclick="removePaintAssociation(${paint.id})">&times;</span>
                `;
                container.appendChild(chip);
            });
        }

        // Funci√≥n para alternar selecci√≥n de pintura
        function togglePaintSelection(paintId) {
            const checkbox = document.getElementById(`paint_${paintId}`);
            const paintItem = checkbox.closest('.paint-item');
            
            if (associatedPaints.has(paintId)) {
                associatedPaints.delete(paintId);
                checkbox.checked = false;
                paintItem.classList.remove('associated');
            } else {
                associatedPaints.add(paintId);
                checkbox.checked = true;
                paintItem.classList.add('associated');
            }
            
            updateAssociatedPaintsDisplay();
        }

        // Funci√≥n para quitar asociaci√≥n de pintura
        function removePaintAssociation(paintId) {
            associatedPaints.delete(paintId);
            const checkbox = document.getElementById(`paint_${paintId}`);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('.paint-item').classList.remove('associated');
            }
            updateAssociatedPaintsDisplay();
        }

        // Funci√≥n para actualizar la visualizaci√≥n de pinturas asociadas
        function updateAssociatedPaintsDisplay() {
            const associatedPaintsList = Array.from(associatedPaints).map(id => 
                allPaintsModal.find(paint => paint.id === id)
            ).filter(paint => paint);
            
            displayAssociatedPaints(associatedPaintsList);
        }

        // Funci√≥n para buscar pinturas en el modal
        function searchPaintsInModal() {
            const searchTerm = document.getElementById('searchPaintsInput').value.toLowerCase();
            const brand = document.getElementById('filterPaintsBrand').value;
            
            let filteredPaints = allPaintsModal.filter(paint => {
                const matchesSearch = !searchTerm || 
                    paint.name.toLowerCase().includes(searchTerm) ||
                    paint.brand.toLowerCase().includes(searchTerm) ||
                    (paint.color_code && paint.color_code.toLowerCase().includes(searchTerm));
                
                const matchesBrand = !brand || paint.brand === brand;
                
                return matchesSearch && matchesBrand;
            });
            
            displayPaintsInModal(filteredPaints);
        }

        // Funci√≥n para filtrar pinturas por marca
        function filterPaintsInModal() {
            searchPaintsInModal();
        }

        // Funci√≥n para guardar las asociaciones
        async function savePaintAssociations() {
            try {
                const paintIds = Array.from(associatedPaints);
                
                const response = await fetch(`/api/videos/${currentVideoId}/paints`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ paint_ids: paintIds })
                });
                
                if (!response.ok) {
                    throw new Error('Error al guardar las asociaciones');
                }
                
                alert('Asociaciones de pinturas guardadas correctamente');
                paintsModal.hide();
                
            } catch (error) {
                console.error('Error al guardar asociaciones:', error);
                alert(`Error al guardar: ${error.message}`);
            }
        }

        // Funci√≥n para establecer el modo de visualizaci√≥n
        function setViewMode(mode) {
            viewMode = mode;
            const container = document.getElementById('videos-container');
            
            document.getElementById('gridViewBtn').classList.remove('active');
            document.getElementById('listViewBtn').classList.remove('active');
            
            if (mode === 'grid') {
                container.className = 'video-grid';
                document.getElementById('gridViewBtn').classList.add('active');
            } else {
                container.className = '';
                document.getElementById('listViewBtn').classList.add('active');
            }
            
            // Redibujar los videos
            displayVideos(allVideos);
        }

        // Funciones para las estad√≠sticas
        async function loadStatistics() {
            const loadingEl = document.getElementById('statisticsLoading');
            const contentEl = document.getElementById('statisticsContent');
            
            // Mostrar carga
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/statistics');
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Estad√≠sticas cargadas:', data);
                
                // Actualizar los datos en la interfaz
                updateDashboardStatistics(data);
                
                // Ocultar carga y mostrar contenido
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
                loadingEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i> Error al cargar estad√≠sticas: ${error.message}
                        <button class="btn btn-outline-danger btn-sm mt-2" onclick="loadStatistics()">
                            <i class="bi bi-arrow-clockwise me-2"></i> Intentar de nuevo
                        </button>
                    </div>
                `;
            }
        }
        
        function updateDashboardStatistics(data) {
            // Verificar si los datos existen antes de usarlos
            if (!data || typeof data !== 'object') {
                console.error('Datos de estad√≠sticas inv√°lidos:', data);
                return;
            }
            
            // M√©tricas principales
            if (data.users && document.getElementById('totalUsers')) {
                document.getElementById('totalUsers').textContent = data.users.total || 0;
            }
            if (data.videos && document.getElementById('totalVideos')) {
                document.getElementById('totalVideos').textContent = data.videos.total || 0;
            }
            if (data.techniques && document.getElementById('totalTechniques')) {
                document.getElementById('totalTechniques').textContent = data.techniques.total || 0;
            }
            if (data.favorites && document.getElementById('totalFavorites')) {
                document.getElementById('totalFavorites').textContent = data.favorites.total || 0;
            }
            
            // Usuarios
            if (data.users) {
                if (document.getElementById('regularUsers')) {
                    document.getElementById('regularUsers').textContent = data.users.regular || 0;
                }
                if (document.getElementById('adminUsers')) {
                    document.getElementById('adminUsers').textContent = data.users.admin || 0;
                }
            }
            
            // T√©cnicas
            if (data.techniques) {
                if (document.getElementById('techniquesCount')) {
                    document.getElementById('techniquesCount').textContent = data.techniques.total || 0;
                }
                if (document.getElementById('avgTechniquesPerVideo')) {
                    document.getElementById('avgTechniquesPerVideo').textContent = data.techniques.avg_per_video || 0;
                }
                if (document.getElementById('totalTechniquesDuration')) {
                    document.getElementById('totalTechniquesDuration').textContent = data.techniques.total_duration_formatted || '0:00';
                }
            }
            
            // Videos populares
            const popularVideosList = document.getElementById('popularVideosList');
            if (data.favorites && data.favorites.popular_videos && data.favorites.popular_videos.length > 0) {
                popularVideosList.innerHTML = '';
                data.favorites.popular_videos.forEach(video => {
                    popularVideosList.innerHTML += `
                        <tr>
                            <td><a href="javascript:void(0)" onclick="editVideo(${video.id})">${video.title}</a></td>
                            <td class="text-end">${video.favorites_count}</td>
                        </tr>
                    `;
                });
            } else {
                popularVideosList.innerHTML = '<tr><td colspan="2" class="text-center">No hay datos disponibles</td></tr>';
            }
            
            // Usuarios activos
            const activeUsersList = document.getElementById('activeUsersList');
            if (data.favorites && data.favorites.active_users && data.favorites.active_users.length > 0) {
                activeUsersList.innerHTML = '';
                data.favorites.active_users.forEach(user => {
                    activeUsersList.innerHTML += `
                        <tr>
                            <td>${user.username}</td>
                            <td class="text-end">${user.favorites_count}</td>
                        </tr>
                    `;
                });
            } else {
                activeUsersList.innerHTML = '<tr><td colspan="2" class="text-center">No hay datos disponibles</td></tr>';
            }
            
             // Videos con m√°s t√©cnicas
            const videosWithTechniquesList = document.getElementById('videosWithMostTechniquesList');
            if (data.techniques && data.techniques.videos_with_most_techniques && data.techniques.videos_with_most_techniques.length > 0) {
                videosWithTechniquesList.innerHTML = '';
                data.techniques.videos_with_most_techniques.forEach(video => {
                    videosWithTechniquesList.innerHTML += `
                        <tr>
                            <td><a href="javascript:void(0)" onclick="editVideo(${video.id})">${video.title}</a></td>
                            <td class="text-end">${video.techniques_count}</td>
                        </tr>
                    `;
                });
            } else {
                videosWithTechniquesList.innerHTML = '<tr><td colspan="2" class="text-center">No hay datos disponibles</td></tr>';
            }
            
            // Generar gr√°ficos
            if (data.users) {
                createUsersChart(data.users);
                if (data.users.by_level) {
                    createUserLevelsChart(data.users.by_level);
                }
            }
            if (data.videos) {
                if (data.videos.by_level) {
                    createVideoDifficultyChart(data.videos.by_level);
                }
                if (data.videos.by_category) {
                    createVideoCategoriesChart(data.videos.by_category);
                }
            }
        }
        
        function createUsersChart(userData) {
            if (!userData) return;
            
            const options = {
                series: [userData.regular || 0, userData.admin || 0],
                chart: {
                    type: 'donut',
                    height: 250
                },
                labels: ['Usuarios', 'Administradores'],
                colors: ['#6c5ce7', '#dc3545'],
                legend: {
                    position: 'bottom'
                }
            };
            
            if (document.querySelector("#usersChart")) {
                const chart = new ApexCharts(document.querySelector("#usersChart"), options);
                if (document.querySelector("#usersChart").innerHTML === '') {
                    chart.render();
                } else {
                    chart.updateOptions(options);
                }
            }
        }
        
        function createUserLevelsChart(levelsData) {
            if (!levelsData) return;
            
            const options = {
                series: [{
                    name: 'Usuarios',
                    data: [levelsData.beginner || 0, levelsData.intermediate || 0, levelsData.expert || 0]
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        dataLabels: {
                            position: 'top',
                        },
                    }
                },
                colors: ['#6c5ce7'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val;
                    },
                    offsetX: 20,
                    style: {
                        fontSize: '12px',
                        colors: ['#304758']
                    }
                },
                xaxis: {
                    categories: ['Principiante', 'Intermedio', 'Experto'],
                }
            };
            
            if (document.querySelector("#userLevelsChart")) {
                const chart = new ApexCharts(document.querySelector("#userLevelsChart"), options);
                if (document.querySelector("#userLevelsChart").innerHTML === '') {
                    chart.render();
                } else {
                    chart.updateOptions(options);
                }
            }
        }
        
        function createVideoDifficultyChart(difficultyData) {
            if (!difficultyData) return;
            
            const options = {
                series: [{
                    name: 'Videos',
                    data: [difficultyData.beginner || 0, difficultyData.intermediate || 0, difficultyData.expert || 0]
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded'
                    },
                },
                colors: ['#20c997'],
                dataLabels: {
                    enabled: true
                },
                xaxis: {
                    categories: ['Principiante', 'Intermedio', 'Experto'],
                }
            };
            
            if (document.querySelector("#videoDifficultyChart")) {
                const chart = new ApexCharts(document.querySelector("#videoDifficultyChart"), options);
                if (document.querySelector("#videoDifficultyChart").innerHTML === '') {
                    chart.render();
                } else {
                    chart.updateOptions(options);
                }
            }
        }
        
        function createVideoCategoriesChart(categoriesData) {
            if (!categoriesData || !Array.isArray(categoriesData)) return;
            
            // Preparar datos para el gr√°fico
            const labels = categoriesData.map(cat => cat.name || 'Sin categor√≠a');
            const series = categoriesData.map(cat => cat.count || 0);
            
            const options = {
                series: series,
                chart: {
                    type: 'pie',
                    height: 300
                },
                labels: labels,
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            height: 200
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };
            
            if (document.querySelector("#videoCategoriesChart")) {
                const chart = new ApexCharts(document.querySelector("#videoCategoriesChart"), options);
                if (document.querySelector("#videoCategoriesChart").innerHTML === '') {
                    chart.render();
                } else {
                    chart.updateOptions(options);
                }
            }
        }

        // üñºÔ∏è LAZY LOADING PARA MINIATURAS DE VIDEOS
        function initializeVideoLazyLoading() {
            console.log('üîç Iniciando lazy loading de videos...');
            
            // Buscar todas las im√°genes lazy
            const lazyImages = document.querySelectorAll('img.lazy-load-video');
            console.log(`üì∏ Encontradas ${lazyImages.length} im√°genes para lazy loading`);
            
            if (lazyImages.length === 0) {
                console.warn('‚ö†Ô∏è No se encontraron im√°genes con clase lazy-load-video');
                return;
            }
            
            // Configurar Intersection Observer para lazy loading
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const realSrc = img.getAttribute('data-src');
                        
                        console.log(`üëÅÔ∏è Imagen visible, cargando: ${realSrc}`);
                        
                        if (realSrc) {
                            // Cargar imagen directamente
                            img.src = realSrc;
                            img.removeAttribute('data-src');
                            img.classList.add('loaded');
                            
                            // Manejar errores
                            img.onerror = function() {
                                console.error('‚ùå Error cargando miniatura:', realSrc);
                                // Intentar con imagen alternativa
                                const videoId = img.getAttribute('data-video-id');
                                if (videoId) {
                                    // Intentar diferentes calidades de miniatura
                                    const altSrc = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                                    console.log(`üîÑ Intentando imagen alternativa: ${altSrc}`);
                                    img.src = altSrc;
                                    
                                    img.onerror = function() {
                                        // Si falla todo, usar placeholder
                                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNDQ0Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2FhYSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yIGNhcmdhbmRvIGltYWdlbjwvdGV4dD48L3N2Zz4=';
                                    };
                                }
                            };
                            
                            // Dejar de observar esta imagen
                            observer.unobserve(img);
                        }
                    }
                });
            }, {
                rootMargin: '50px',
                threshold: 0.01
            });
            
            // Observar todas las im√°genes lazy
            lazyImages.forEach(img => {
                imageObserver.observe(img);
            });
            
            console.log(`‚úÖ Lazy loading inicializado correctamente`);
            
            // Forzar carga de las primeras im√°genes visibles
            setTimeout(() => {
                lazyImages.forEach(img => {
                    const rect = img.getBoundingClientRect();
                    if (rect.top < window.innerHeight && rect.bottom > 0) {
                        const realSrc = img.getAttribute('data-src');
                        if (realSrc) {
                            console.log(`üöÄ Carga forzada de imagen visible: ${realSrc}`);
                            img.src = realSrc;
                            img.removeAttribute('data-src');
                            img.classList.add('loaded');
                        }
                    }
                });
            }, 100);
        }

        // Funci√≥n para reproducir video al hacer clic en la miniatura
        function playVideo(imgElement, videoId) {
            const container = imgElement.closest('.youtube-container');
            container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allowfullscreen allow="autoplay"></iframe>`;
        }

        // Lazy loading ya se inicializa autom√°ticamente en displayVideos()

        // Inicializar lazy loading cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM cargado, esperando para inicializar lazy loading...');
            setTimeout(() => {
                console.log('‚è∞ Iniciando lazy loading despu√©s del timeout...');
                initializeVideoLazyLoading();
            }, 500);
        });
        
        // Tambi√©n inicializar cuando se cargan los videos por primera vez
        window.addEventListener('load', function() {
            console.log('üåê P√°gina completamente cargada');
            if (document.querySelectorAll('img.lazy-load-video').length > 0) {
                initializeVideoLazyLoading();
            }
        });
    </script>
    <!-- Script para ApexCharts necesario para las estad√≠sticas -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</body>
</html>